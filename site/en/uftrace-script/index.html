<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Uftrace script - uftrace</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Uftrace script";
        var mkdocs_page_input_path = "en/uftrace-script.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> uftrace
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">en</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../uftrace/">home</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ko</span></p>
              <ul>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">uftrace</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Uftrace script</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <p>% UFTRACE-SCRIPT(1) Uftrace User Manuals
% Honggyu Kim <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#104;&#111;&#110;&#103;&#103;&#121;&#117;&#46;&#107;&#112;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;">&#104;&#111;&#110;&#103;&#103;&#121;&#117;&#46;&#107;&#112;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;</a>, Namhyung Kim <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#110;&#97;&#109;&#104;&#121;&#117;&#110;&#103;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;">&#110;&#97;&#109;&#104;&#121;&#117;&#110;&#103;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;</a>
% Sep, 2018</p>
<h1 id="name">NAME</h1>
<p>uftrace-script - Run a script for recorded function trace</p>
<h1 id="synopsis">SYNOPSIS</h1>
<p>uftrace script (-S|--script) <script file> [<em>options</em>]
uftrace script (-S|--script) <script file> [<em>options</em>] --record COMMAND</p>
<h1 id="description">DESCRIPTION</h1>
<p>This command runs a script for trace data recorded using the <code>uftrace-record</code>(1) command.</p>
<h1 id="script-options">SCRIPT OPTIONS</h1>
<p>-S <em>SCRIPT_PATH</em>, --script=<em>SCRIPT_PATH</em>
:   Run a given script to do additional work at the entry and exit of function
    while processing recorded trace data.
    The type of script is detected by the file extension.
    For example '.py' for python and '.lua' for lua 5.1.
    See <em>SCRIPT EXECUTION</em>.</p>
<p>--record COMMAND [<em>command-options</em>]
:   Record a new trace before running a given script.</p>
<p>--no-args
:   Do not show function arguments and return value.</p>
<h1 id="common-options">COMMON OPTIONS</h1>
<p>-F <em>FUNC</em>, --filter=<em>FUNC</em>
:   Set filter to trace selected functions and their children functions.
    This option can be used more than once.
    See <code>uftrace-replay</code>(1) for an explanation of filters.</p>
<p>-N <em>FUNC</em>, --notrace=<em>FUNC</em>
:   Set filter not to trace selected functions and their children functions.
    This option can be used more than once.
    See <code>uftrace-replay</code>(1) for an explanation of filters.</p>
<p>-C <em>FUNC</em>, --caller-filter=<em>FUNC</em>
:   Set filter to trace callers of selected functions only.
    This option can be used more than once.
    See <code>uftrace-replay</code>(1) for an explanation of filters.</p>
<p>-T <em>TRG</em>, --trigger=<em>TRG</em>
:   Set trigger on selected functions.  This option can be used more than once.
    See 'uftrace-replay' for details.</p>
<p>-D <em>DEPTH</em>, --depth <em>DEPTH</em>
:   Set trace limit in nesting level.</p>
<p>-t <em>TIME</em>, --time-filter=<em>TIME</em>
:   Do not run script for functions which run under the time threshold.  If some
    functions explicitly have the 'trace' trigger applied, those are always
    traced regardless of execution time.</p>
<p>-Z <em>SIZE</em>, --size-filter=<em>SIZE</em>
:   Do not show functions smaller than SIZE bytes.</p>
<p>-L <em>LOCATION</em>, --loc-filter=<em>LOCATION</em>
:   Set filter to trace selected source locations.
    This option can be used more than once.</p>
<p>--no-libcall
:   Do not run script for library calls.</p>
<p>--match=<em>TYPE</em>
:   Use pattern match using TYPE.  Possible types are <code>regex</code> and <code>glob</code>.
    Default is <code>regex</code>.</p>
<p>--with-syms=<em>DIR</em>
:   Read symbol data from the .sym files in <em>DIR</em> directory instead of the
    binary.  This can be useful to deal with stripped binaries.  The file name
    of the main binary should be the same when saved and used.</p>
<h1 id="common-analysis-options">COMMON ANALYSIS OPTIONS</h1>
<p>-H <em>FUNC</em>, --hide=<em>FUNC</em>
:   Set filter not to trace selected functions.
    It doesn't affect their subtrees, but hides only the given functions.
    This option can be used more than once.
    See <code>uftrace-replay</code>(1) for an explanation of filters.</p>
<p>--kernel-full
:   Run script all kernel functions and events occurred outside of user functions.</p>
<p>--kernel-only
:   Run script kernel functions only without user functions.</p>
<p>--tid=<em>TID</em>[,<em>TID</em>,...]
:   Run script only for functions called by the given tasks.  To see the list of
    tasks in the data file, you can use <code>uftrace report --task</code> or
    <code>uftrace info</code>.  This option can also be used more than once.</p>
<p>--demangle=<em>TYPE</em>
:   Use demangled C++ symbol names for filters, triggers, arguments and/or
    return values.  Possible values are "full", "simple" and "no".  Default is
    "simple" which ignores function arguments and template parameters.</p>
<p>-r <em>RANGE</em>, --time-range=<em>RANGE</em>
:   Run script only for functions executed within the time RANGE.  The RANGE can
    be \&lt;start&gt;~\&lt;stop&gt; (separated by "~") and one of \&lt;start&gt; and \&lt;stop&gt;
    can be omitted.  The \&lt;start&gt; and \&lt;stop&gt; are timestamp or elapsed time if
    they have \&lt;time_unit&gt; postfix, for example '100us'.  The timestamp or
    elapsed time can be shown with <code>-f time</code> or <code>-f elapsed</code> option respectively
    in <code>uftrace replay</code>(1).</p>
<h1 id="script-execution">SCRIPT EXECUTION</h1>
<p>The uftrace tool supports script execution for each function entry and exit.
The supported script types are Python 2.7, Python 3 and Lua 5.1 as of now.</p>
<p>The user can write five functions. 'uftrace_entry' and 'uftrace_exit' are
executed whenever each function is executed at the entry and exit.  However
'uftrace_begin' and 'uftrace_end' are only executed once when the target
program begins and ends.  'uftrace_event' is called when it sees an event.</p>
<pre><code>$ cat scripts/simple.py
def uftrace_begin(ctx):
    print("program begins...")

def uftrace_entry(ctx):
    func = ctx["name"]
    print("entry : " + func + "()")

def uftrace_exit(ctx):
    func = ctx["name"]
    print("exit  : " + func + "()")

def uftrace_event(ctx):
    name = ctx["name"]
    print("event : " + name)

def uftrace_end():
    print("program is finished")
</code></pre>
<p>The 'ctx' variable is a dictionary type that contains the below information.</p>
<pre><code>/* context information passed to uftrace_entry(ctx) and uftrace_exit(ctx) */
script_context = {
    int       tid;
    int       depth;
    long      timestamp;
    long      duration;    # exit only
    long      address;
    string    name;
    list      args;        # entry only (if available)
    value     retval;      # exit  only (if available)
};

/* context information passed to uftrace_begin(ctx) */
script_context = {
    bool      record;      # True if it runs at record time, otherwise False
    string    version;     # uftrace version info
    list      cmds;        # execution commands
};
</code></pre>
<p>The above script can be executed while reading the recorded data.  The usage
is as follows:</p>
<pre><code>$ uftrace record -F main tests/t-abc

$ uftrace script -S scripts/simple.py
program begins...
entry : main()
entry : a()
entry : b()
entry : c()
entry : getpid()
exit  : getpid()
exit  : c()
exit  : b()
exit  : a()
exit  : main()
program is finished
</code></pre>
<p>The below is another example that shows the different output compared to
previous one for the same recorded data.  The output looks similar to
<code>uftrace replay</code> this time.</p>
<pre><code>$ uftrace script -S scripts/replay.py
# DURATION    TID     FUNCTION
            [25794] | main() {
            [25794] |   a() {
            [25794] |     b() {
            [25794] |       c() {
            [25794] |         getpid() {
  11.037 us [25794] |         } /* getpid */
  44.752 us [25794] |       } /* c */
  70.924 us [25794] |     } /* b */
  98.191 us [25794] |   } /* a */
 124.329 us [25794] | } /* main */
</code></pre>
<p>The script above can be modified to do more output customization.</p>
<p>A script can have an optional "UFTRACE_FUNCS" list which can have name
(or pattern depending on the --match option) of functions to run the script.
If it exists, only matched functions will run the script.  For example, if you
add following lines to the script, it will run only for functions with a single
letter name.</p>
<pre><code>$ echo 'UFTRACE_FUNCS = [ "^.$" ]' &gt;&gt; replay.py
$ uftrace script -S replay.py
# DURATION    TID     FUNCTION
            [25794] |   a() {
            [25794] |     b() {
            [25794] |       c() {
  44.752 us [25794] |       } /* c */
  70.924 us [25794] |     } /* b */
  98.191 us [25794] |   } /* a */
</code></pre>
<p>Also a script can have options for record if it requires some form of data
(i.e. function argument or return value).  A comment line started with
"uftrace-option:" will provide (a part of) such options when recording.</p>
<pre><code>$ cat arg.py
#
# uftrace-option: -A a@arg1 -R b@retval
#
def uftrace_entry(ctx):
    if "args" in ctx:
        print(ctx["name"] + " has args")
def uftrace_exit(ctx):
    if "retval" in ctx:
        print(ctx["name"] + " has retval")

$ uftrace record -S arg.py abc
a has args
b has retval
$ uftrace script -S arg.py
a has args
b has retval
</code></pre>
<p>Also a script can handle event records and optional event data in "args".  The
argument is a string containing KEY=VALUE pairs.  Currently it only works with
<code>uftrace script</code> and not for record.</p>
<pre><code>$ cat event.py
def uftrace_entry(ctx):
    pass
def uftrace_exit(ctx):
    pass
def uftrace_event(ctx):
    if "args" in ctx:
        print(ctx["name"] + " ::: " + ctx["args"])
    else:
        print(ctx["name"])

$ uftrace record -T a@read=proc/statm abc
$ uftrace script -S event.py
read:proc/statm ::: vmsize=31060KB vmrss=15412KB shared=11064KB
diff:proc/statm ::: vmsize=+0KB vmrss=+0KB shared=+0KB
</code></pre>
<h1 id="see-also">SEE ALSO</h1>
<p><code>uftrace</code>(1), <code>uftrace-record</code>(1), <code>uftrace-replay</code>(1), <code>uftrace-live</code>(1)</p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
